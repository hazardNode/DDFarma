{% extends "base.html" %}

{% block title %}Checkout - Payment - {{ block.super }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl font-extrabold tracking-tight text-gray-900 mb-8">Checkout</h1>
    
    <!-- Checkout Progress -->
    <div class="mb-8">
        <div class="flex items-center justify-center">
            <div class="flex-1">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-green-600 h-10 w-10 rounded-full flex items-center justify-center">
                        <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                    <div class="ml-4 text-lg font-medium text-green-600">Shipping</div>
                </div>
            </div>
            <div class="w-24 h-1 bg-blue-600"></div>
            <div class="flex-1">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-blue-600 h-10 w-10 rounded-full flex items-center justify-center">
                        <span class="text-white font-bold">2</span>
                    </div>
                    <div class="ml-4 text-lg font-medium text-blue-600">Payment</div>
                </div>
            </div>
            <div class="w-24 h-1 bg-gray-200"></div>
            <div class="flex-1">
                <div class="flex items-center">
                    <div class="flex-shrink-0 bg-gray-200 h-10 w-10 rounded-full flex items-center justify-center">
                        <span class="text-gray-600 font-bold">3</span>
                    </div>
                    <div class="ml-4 text-lg font-medium text-gray-600">Confirmation</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left column: Payment Method -->
        <div class="lg:col-span-2">
            <div class="bg-white shadow overflow-hidden sm:rounded-lg p-6">
                <form id="payment-form">
                    {% csrf_token %}
                    
                    <!-- Selected Address Summary -->
                    <div class="mb-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-2">Shipping Information</h2>
                        <div class="bg-gray-50 rounded-md p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500 mb-1">Shipping Address</h3>
                                    <p class="font-medium">{{ shipping_address.street }}</p>
                                    <p>{{ shipping_address.city }}, {{ shipping_address.province }} {{ shipping_address.postal_code }}</p>
                                    <p>{{ shipping_address.phone }}</p>
                                </div>
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500 mb-1">Shipping Method</h3>
                                    <p class="font-medium">{{ shipping_method.name }}</p>
                                    <p>${{ shipping_method.cost }}</p>
                                </div>
                            </div>
                            <div class="mt-2 text-sm">
                                <a href="{% url 'checkout' %}" class="text-blue-600 hover:text-blue-800">Edit</a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Payment Methods Section -->
                    <div class="mb-8">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">Payment Method</h2>
                        
                        {% if payment_methods %}
                            <div class="space-y-4 mb-6">
                                {% for payment in payment_methods %}
                                <div class="relative">
                                    <input type="radio" id="payment_{{ payment.id }}" name="payment_method" 
                                           value="{{ payment.payment_method_id }}" 
                                           class="hidden peer" 
                                           {% if payment.is_default or forloop.first %}checked{% endif %}>
                                    <label for="payment_{{ payment.id }}" 
                                           class="block p-4 border rounded-md cursor-pointer peer-checked:border-blue-500 peer-checked:ring-2 peer-checked:ring-blue-500">
                                        <div class="flex items-center">
                                            {% if payment.payment_type == 'card' %}
                                            <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                            </svg>
                                            {% elif payment.payment_type == 'sepa_debit' %}
                                            <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path>
                                            </svg>
                                            {% else %}
                                            <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2z"></path>
                                            </svg>
                                            {% endif %}
                                            <div class="ml-3">
                                                <p class="font-medium">{{ payment.display_name }}</p>
                                                {% if payment.expiry_month and payment.expiry_year %}
                                                <p class="text-sm text-gray-500">Expires: {{ payment.expiry_month }}/{{ payment.expiry_year }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% if payment.is_default %}
                                        <span class="absolute top-2 right-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            Default
                                        </span>
                                        {% endif %}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="border-t border-gray-200 pt-4 mb-6">
                                <div class="flex items-center">
                                    <input id="add_new_payment" name="add_new_payment" type="checkbox"
                                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <label for="add_new_payment" class="ml-2 block text-sm text-gray-900">
                                        Add a new payment method
                                    </label>
                                </div>
                            </div>
                        {% endif %}
                        
                        <!-- New Payment Method Section -->
                        <div id="new_payment_section" class="{% if payment_methods %}hidden{% endif %}">
                            <div id="card-element-container" class="mb-4">
                                <label for="card-element" class="block text-sm font-medium text-gray-700 mb-2">Credit or Debit Card</label>
                                <div id="card-element" class="p-3 border border-gray-300 rounded-md">
                                    <!-- Stripe Card Element will be inserted here -->
                                </div>
                                <div id="card-errors" class="mt-2 text-sm text-red-600" role="alert"></div>
                            </div>
                            
                            <!-- Toggle to show SEPA bank option -->
                            <div class="flex items-center mb-4">
                                <input id="use_bank_account" name="use_bank_account" type="checkbox"
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="use_bank_account" class="ml-2 block text-sm text-gray-900">
                                    Pay with bank account (SEPA Direct Debit)
                                </label>
                            </div>
                            
                            <!-- SEPA Elements Container -->
                            <div id="sepa-element-container" class="hidden mb-4">
                                <div class="mb-4">
                                    <label for="account_holder_name" class="block text-sm font-medium text-gray-700 mb-2">Account Holder Name</label>
                                    <input type="text" id="account_holder_name" class="mt-1 p-3 block w-full border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                
                                <label for="iban-element" class="block text-sm font-medium text-gray-700 mb-2">IBAN</label>
                                <div id="iban-element" class="p-3 border border-gray-300 rounded-md">
                                    <!-- Stripe IBAN Element will be inserted here -->
                                </div>
                                <div id="iban-errors" class="mt-2 text-sm text-red-600" role="alert"></div>
                                
                                <div class="mt-2 text-xs text-gray-500">
                                    By providing your IBAN and confirming this payment, you are authorizing our company and Stripe, our payment service provider, to send instructions to your bank to debit your account. You are entitled to a refund from your bank under the terms and conditions of your agreement with your bank. A refund must be claimed within 8 weeks starting from the date on which your account was debited.
                                </div>
                            </div>
                            
                            <div class="flex items-center mb-4">
                                <input id="save_payment_method" name="save_payment_method" type="checkbox" checked
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="save_payment_method" class="ml-2 block text-sm text-gray-900">
                                    Save this payment method for future orders
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Place Order Button -->
                    <div class="mt-8">
                        <button type="submit" id="place-order-button"
                                class="w-full inline-flex justify-center py-3 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Place Order
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Right column: Order Summary -->
        <div class="lg:col-span-1">
            <div class="bg-white shadow overflow-hidden sm:rounded-lg p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Order Summary</h2>
                
                <div class="space-y-4 mb-6">
                    {% for item in cart %}
                    <div class="flex items-start">
                        <div class="flex-shrink-0 h-16 w-16">
                            {% if item.image_url %}
                                <img class="h-16 w-16 object-cover rounded" src="{{ item.image_url }}" alt="{{ item.product.name }}">
                            {% else %}
                                <img class="h-16 w-16 object-cover rounded" src="https://via.placeholder.com/150" alt="{{ item.product.name }}">
                            {% endif %}
                        </div>
                        <div class="ml-4 flex-1">
                            <div class="font-medium text-gray-900">{{ item.product.name }}</div>
                            <div class="text-sm text-gray-500">Qty: {{ item.quantity }}</div>
                            <div class="text-gray-900">${{ item.total_price }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="border-t pt-4">
                    <div class="flex justify-between mb-2">
                        <div class="text-gray-600">Subtotal</div>
                        <div class="font-medium">${{ cart_total }}</div>
                    </div>
                    <div class="flex justify-between mb-2">
                        <div class="text-gray-600">Shipping</div>
                        <div class="font-medium">${{ shipping_cost }}</div>
                    </div>
                    <div class="flex justify-between border-t border-gray-200 pt-4 mt-4">
                        <div class="text-lg font-semibold">Total</div>
                        <div class="text-lg font-bold">${{ order_total }}</div>
                    </div>
                </div>
                
                <div class="mt-6">
                    <a href="{% url 'checkout' %}" class="text-blue-600 hover:text-blue-800 flex items-center justify-center">
                        <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                        Return to shipping
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-5 rounded-lg shadow-xl flex items-center">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Processing payment...</span>
    </div>
</div>

<!-- Notification Element -->
<div id="notification"
     class="fixed bottom-4 right-4 z-50 w-72 max-w-full opacity-0 transform translate-y-2 transition-all duration-300 ease-in-out">
    <div class="bg-red-500 text-white px-4 py-3 rounded-lg shadow-lg">
        <div class="flex items-center justify-between">
            <span id="notification-message" class="block font-medium">Please select a payment method</span>
            <button type="button" class="ml-2 flex-shrink-0" onclick="dismissNotification()">
                <svg class="h-4 w-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                          d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                          clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
    </div>
</div>

<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>
<script>
    // Initialize Stripe
    const stripe = Stripe('{{ stripe_publishable_key }}');
    const elements = stripe.elements();
    let cardElement = null;
    let ibanElement = null;
    let paymentType = 'card';
    
    function setupCardElement() {
        // Create card Element
        cardElement = elements.create('card', {
            style: {
                base: {
                    color: '#32325d',
                    fontFamily: '"Helvetica Neue", sans-serif',
                    fontSmoothing: 'antialiased',
                    fontSize: '16px',
                    '::placeholder': {
                        color: '#aab7c4'
                    }
                },
                invalid: {
                    color: '#fa755a',
                    iconColor: '#fa755a'
                }
            }
        });
        
        // Mount the card Element
        cardElement.mount('#card-element');
        
        // Handle real-time validation errors
        cardElement.on('change', function(event) {
            const displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });
    }
    
    function setupIbanElement() {
        // Create IBAN Element
        ibanElement = elements.create('iban', {
            style: {
                base: {
                    color: '#32325d',
                    fontFamily: '"Helvetica Neue", sans-serif',
                    fontSmoothing: 'antialiased',
                    fontSize: '16px',
                    '::placeholder': {
                        color: '#aab7c4'
                    }
                },
                invalid: {
                    color: '#fa755a',
                    iconColor: '#fa755a'
                }
            },
            supportedCountries: ['SEPA']
        });
        
        // Mount the IBAN Element
        ibanElement.mount('#iban-element');
        
        // Handle real-time validation errors
        ibanElement.on('change', function(event) {
            const displayError = document.getElementById('iban-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });
    }
    
    $(document).ready(function() {
        // Setup card Element initially
        setupCardElement();
        
        // Handle "Add new payment method" checkbox
        $('#add_new_payment').change(function() {
            if ($(this).is(':checked')) {
                $('#new_payment_section').removeClass('hidden');
                $('input[name="payment_method"]').prop('disabled', true);
            } else {
                $('#new_payment_section').addClass('hidden');
                $('input[name="payment_method"]').prop('disabled', false);
            }
        });
        
        // Handle toggle between card and bank account
        $('#use_bank_account').change(function() {
            if ($(this).is(':checked')) {
                $('#card-element-container').addClass('hidden');
                $('#sepa-element-container').removeClass('hidden');
                paymentType = 'sepa_debit';
                if (!ibanElement) {
                    setupIbanElement();
                }
            } else {
                $('#card-element-container').removeClass('hidden');
                $('#sepa-element-container').addClass('hidden');
                paymentType = 'card';
            }
        });
        
        // Form submission handler
        $('#payment-form').submit(function(e) {
            e.preventDefault();
            
            // Show loading overlay
            $('#loading-overlay').removeClass('hidden');
            $('#place-order-button').prop('disabled', true);
            
            // Check if using existing payment method or creating a new one
            const useExistingPayment = !$('#add_new_payment').is(':checked') && $('input[name="payment_method"]:checked').length > 0;
            
            if (useExistingPayment) {
                // Using existing payment method
                const paymentMethodId = $('input[name="payment_method"]:checked').val();
                processPayment(paymentMethodId);
            } else {
                // Creating a new payment method
                if (paymentType === 'card') {
                    // Create payment method with card
                    stripe.createPaymentMethod({
                        type: 'card',
                        card: cardElement,
                    }).then(function(result) {
                        if (result.error) {
                            handlePaymentError(result.error.message);
                        } else {
                            processPayment(result.paymentMethod.id);
                        }
                    });
                } else if (paymentType === 'sepa_debit') {
                    // Check account holder name
                    const accountHolderName = $('#account_holder_name').val();
                    if (!accountHolderName) {
                        handlePaymentError('Please enter the account holder name');
                        return;
                    }
                    
                    // Create payment method with IBAN
                    stripe.createPaymentMethod({
                        type: 'sepa_debit',
                        sepa_debit: ibanElement,
                        billing_details: {
                            name: accountHolderName,
                            email: '{{ user.email }}'
                        }
                    }).then(function(result) {
                        if (result.error) {
                            handlePaymentError(result.error.message);
                        } else {
                            processPayment(result.paymentMethod.id);
                        }
                    });
                }
            }
        });
        
        function processPayment(paymentMethodId) {
            // Create payment intent
            $.ajax({
                url: '{% url "create_payment_intent" %}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    payment_method_id: paymentMethodId,
                    save_payment_method: $('#save_payment_method').is(':checked')
                }),
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('X-CSRFToken', $('input[name="csrfmiddlewaretoken"]').val());
                },
                success: function(response) {
                    if (response.success) {
                        if (response.requires_action) {
                            // Use Stripe.js to handle required card action
                            stripe.handleCardAction(
                                response.payment_intent_client_secret
                            ).then(function(result) {
                                if (result.error) {
                                    handlePaymentError(result.error.message);
                                } else {
                                    // The card action has been handled
                                    // The PaymentIntent can be confirmed again on the server
                                    window.location.href = response.redirect_url;
                                }
                            });
                        } else {
                            // No additional authentication required
                            window.location.href = response.redirect_url;
                        }
                    } else {
                        handlePaymentError(response.message || 'An error occurred while processing your payment');
                    }
                },
                error: function() {
                    handlePaymentError('An error occurred. Please try again.');
                }
            });
        }
        
        function handlePaymentError(message) {
            $('#loading-overlay').addClass('hidden');
            $('#place-order-button').prop('disabled', false);
            showNotification(message);
        }
    });
    
    // Function to show notification
    function showNotification(message) {
        const $notification = $('#notification');
        const $notificationMessage = $('#notification-message');
        
        // Set message text
        $notificationMessage.text(message);
        
        // Show notification with animation
        $notification.removeClass('opacity-0 translate-y-2');
        
        // Auto-dismiss after 3 seconds
        setTimeout(function() {
            dismissNotification();
        }, 3000);
    }
    
    // Function to dismiss notification
    function dismissNotification() {
        const $notification = $('#notification');
        $notification.addClass('opacity-0 translate-y-2');
    }
</script>
{% endblock %}