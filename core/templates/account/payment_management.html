<!-- payment_management.html with Stripe Elements integration including SEPA bank accounts -->
{% extends "base.html" %}

{% block title %}Payment Methods - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    /* Stripe Elements custom styling */
    .StripeElement {
        box-sizing: border-box;
        height: 40px;
        padding: 10px 12px;
        border: 1px solid #E5E7EB;
        border-radius: 0.375rem;
        background-color: white;
        transition: box-shadow 150ms ease;
    }

    .StripeElement--focus {
        box-shadow: 0 0 0 2px #3B82F6;
    }

    .StripeElement--invalid {
        border-color: #EF4444;
    }

    .StripeElement--webkit-autofill {
        background-color: #F3F9FF !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto mt-8">
    <h2 class="text-2xl font-bold mb-6 text-gray-800">My Account</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Left sidebar: Account navigation -->
        <div class="col-span-1">
            <div class="bg-white rounded-lg shadow p-4">
                <h3 class="text-lg font-medium text-gray-700 mb-4">Account Menu</h3>
                <nav class="space-y-2">
                    <a href="{% url 'account_dashboard' %}"
                       class="block px-4 py-2 rounded-md text-gray-700 hover:bg-gray-50 hover:text-blue-600">
                        Personal Information
                    </a>
                    <a href="{% url 'address_management' %}"
                       class="block px-4 py-2 rounded-md text-gray-700 hover:bg-gray-50 hover:text-blue-600">
                        Addresses
                    </a>
                    <a href="{% url 'payment_management' %}"
                       class="block px-4 py-2 rounded-md text-blue-600 bg-blue-50 font-medium">
                        Payment Methods
                    </a>
                    <a href="{% url 'order_history' %}"
                       class="block px-4 py-2 rounded-md text-gray-700 hover:bg-gray-50 hover:text-blue-600">
                        Order History
                    </a>
                    <a href="{% url 'account_email' %}"
                       class="block px-4 py-2 rounded-md text-gray-700 hover:bg-gray-50 hover:text-blue-600">
                        Email Settings
                    </a>
                    <a href="{% url 'account_change_password' %}"
                       class="block px-4 py-2 rounded-md text-gray-700 hover:bg-gray-50 hover:text-blue-600">
                        Change Password
                    </a>
                    <form method="post" action="{% url 'account_logout' %}" class="mt-4">
                        {% csrf_token %}
                        {% if redirect_field_value %}
                        <input type="hidden" name="{{ redirect_field_name }}" value="{{ redirect_field_value }}"/>
                        {% endif %}
                        <button type="submit" class="w-full text-left px-4 py-2 rounded-md text-red-600 hover:bg-red-50 font-medium">
                            Sign Out
                        </button>
                    </form>
                </nav>
            </div>
        </div>

        <!-- Right content: Main content area -->
        <div class="col-span-1 md:col-span-2">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">Payment Methods</h3>
                    <button id="addPaymentBtn" type="button"
                        class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Add Payment Method
                    </button>
                </div>

                <!-- Payment Method List -->
                {% if payment_methods %}
                <div class="space-y-4">
                    {% for payment in payment_methods %}
                    <div class="border rounded-lg p-4 {% if payment.is_default %}bg-blue-50 border-blue-200{% else %}border-gray-200{% endif %}">
                        <div class="flex justify-between">
                            <div>
                                <div class="flex items-center">
                                    {% if payment.payment_type == 'card' %}
                                    <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                    </svg>
                                    {% elif payment.payment_type == 'sepa_debit' %}
                                    <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path>
                                    </svg>
                                    {% else %}
                                    <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2z"></path>
                                    </svg>
                                    {% endif %}
                                    <div class="ml-3">
                                        <p class="font-medium">{{ payment.display_name }}</p>
                                        {% if payment.is_default %}
                                        <span class="inline-flex mt-1 items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            Default
                                        </span>
                                        {% endif %}
                                        {% if payment.expiry_month and payment.expiry_year %}
                                        <p class="text-sm text-gray-500">Expires: {{ payment.expiry_month }}/{{ payment.expiry_year }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col space-y-2">
                                {% if not payment.is_default %}
                                <button data-payment-id="{{ payment.id }}" class="makeDefaultPaymentBtn text-sm text-gray-600 hover:text-gray-800">
                                    Set as Default
                                </button>
                                <button data-payment-id="{{ payment.id }}" class="deletePaymentBtn text-sm text-red-600 hover:text-red-800">
                                    Delete
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8 bg-gray-50 rounded-lg">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No payment methods</h3>
                    <p class="mt-1 text-sm text-gray-500">
                        You haven't added any payment methods yet.
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Payment Method Form Modal -->
<div id="paymentModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 mx-4">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-medium text-gray-900">Add Payment Method</h3>
            <button id="closePaymentModal" class="text-gray-400 hover:text-gray-500">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <form id="paymentForm">
            {% csrf_token %}

            <div class="space-y-4">
                <div>
                    <label for="payment_type" class="block text-sm font-medium text-gray-700">Payment Type</label>
                    <select id="payment_type" name="payment_type" required
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                        <option value="card">Credit/Debit Card</option>
                        <option value="sepa_debit">Bank Account (SEPA Direct Debit)</option>
                    </select>
                </div>

                <!-- Credit Card Fields -->
                <div id="cardElementContainer">
                    <div id="cardElement" class="mt-2">
                        <!-- Stripe Card Element will be inserted here -->
                    </div>
                </div>

                <!-- SEPA Bank Account Fields -->
                <div id="sepaElementContainer" class="hidden">
                    <div class="mb-4">
                        <label for="account_holder_name" class="block text-sm font-medium text-gray-700">Account Holder Name</label>
                        <input type="text" id="account_holder_name" name="account_holder_name"
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div id="ibanElement" class="mt-2">
                        <!-- Stripe IBAN Element will be inserted here -->
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        By providing your IBAN and confirming this payment, you are authorizing our company and Stripe, our payment service provider, to send instructions to your bank to debit your account. You are entitled to a refund from your bank under the terms and conditions of your agreement with your bank. A refund must be claimed within 8 weeks starting from the date on which your account was debited.
                    </div>
                </div>

                <div id="paymentErrors" class="mt-2 text-sm text-red-600" role="alert"></div>

                <div class="flex items-center">
                    <input type="checkbox" id="is_default_payment" name="is_default_payment" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="is_default_payment" class="ml-2 block text-sm text-gray-900">
                        Set as default payment method
                    </label>
                </div>
            </div>

            <div class="mt-5 sm:mt-6">
                <button type="submit" id="savePaymentBtn"
                    class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm">
                    Save Payment Method
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deletePaymentModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6 mx-4">
        <div class="mb-4">
            <h3 class="text-lg font-medium text-gray-900">Delete Payment Method</h3>
            <p class="mt-2 text-sm text-gray-500">
                Are you sure you want to delete this payment method? This action cannot be undone.
            </p>
        </div>

        <div class="mt-5 sm:mt-6 flex space-x-2">
            <button id="cancelDeletePaymentBtn"
                class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm">
                Cancel
            </button>
            <button id="confirmDeletePaymentBtn"
                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:text-sm">
                Delete
            </button>
        </div>
    </div>
</div>

<!-- Processing Overlay -->
<div id="processingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-4 rounded-lg shadow-lg flex items-center">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Processing...</span>
    </div>
</div>

<!-- Notification Element -->
<div id="notification"
    class="fixed bottom-4 right-4 px-4 py-2 rounded-md text-white bg-green-500 opacity-0 transition-opacity duration-500">
</div>

{% block extra_js %}
<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>
<script>
    // Initialize Stripe
    const stripe = Stripe('{{ stripe_publishable_key }}');
    const elements = stripe.elements();
    let card, iban;
    let paymentMethodType = 'card'; // Default payment method type

    function showNotification(message, type = 'success') {
        const $notification = $('#notification');
        $notification.text(message);

        if (type === 'error') {
            $notification.removeClass('bg-green-500').addClass('bg-red-500');
        } else {
            $notification.removeClass('bg-red-500').addClass('bg-green-500');
        }

        $notification.css('opacity', '1');

        setTimeout(function () {
            $notification.css('opacity', '0');
        }, 3000);
    }

    function showProcessing(show = true) {
        if (show) {
            $('#processingOverlay').removeClass('hidden');
        } else {
            $('#processingOverlay').addClass('hidden');
        }
    }

    $(document).ready(function() {
        // Toggle payment type fields
        $('#payment_type').change(function() {
            paymentMethodType = $(this).val();

            // Hide all payment fields
            $('#cardElementContainer, #sepaElementContainer').addClass('hidden');

            // Show fields based on selected payment type
            if (paymentMethodType === 'card') {
                $('#cardElementContainer').removeClass('hidden');
                setupCardElement();
            } else if (paymentMethodType === 'sepa_debit') {
                $('#sepaElementContainer').removeClass('hidden');
                setupIbanElement();
            }
        });

        // Create and mount the Stripe card Element
        function setupCardElement() {
            if (card) {
                card.destroy();
            }

            // Create a card Element
            card = elements.create('card', {
                style: {
                    base: {
                        color: '#32325d',
                        fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                        fontSmoothing: 'antialiased',
                        fontSize: '16px',
                        '::placeholder': {
                            color: '#aab7c4'
                        }
                    },
                    invalid: {
                        color: '#fa755a',
                        iconColor: '#fa755a'
                    }
                }
            });

            // Mount the Element to the div
            card.mount('#cardElement');

            // Handle real-time validation errors
            card.on('change', function(event) {
                const displayError = document.getElementById('paymentErrors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                } else {
                    displayError.textContent = '';
                }
            });
        }

        // Create and mount the Stripe IBAN Element for SEPA Direct Debit
        function setupIbanElement() {
            if (iban) {
                iban.destroy();
            }

            // Create an IBAN Element
            iban = elements.create('iban', {
                style: {
                    base: {
                        color: '#32325d',
                        fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
                        fontSmoothing: 'antialiased',
                        fontSize: '16px',
                        '::placeholder': {
                            color: '#aab7c4'
                        }
                    },
                    invalid: {
                        color: '#fa755a',
                        iconColor: '#fa755a'
                    }
                },
                supportedCountries: ['SEPA'], // SEPA includes Spain
            });

            // Mount the Element to the div
            iban.mount('#ibanElement');

            // Handle real-time validation errors
            iban.on('change', function(event) {
                const displayError = document.getElementById('paymentErrors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                } else {
                    displayError.textContent = '';
                }
            });
        }

        // Open payment modal
        $('#addPaymentBtn').click(function() {
            // Reset form
            $('#paymentForm')[0].reset();
            $('#paymentErrors').text('');

            // Default to card payment type
            $('#payment_type').val('card');
            paymentMethodType = 'card';

            // Show card fields, hide others
            $('#cardElementContainer').removeClass('hidden');
            $('#sepaElementContainer').addClass('hidden');

            // Setup Stripe Elements
            setupCardElement();

            // Show modal
            $('#paymentModal').removeClass('hidden');
        });

        // Close payment modal
        $('#closePaymentModal').click(function() {
            $('#paymentModal').addClass('hidden');
        });

        // Save payment method
        $('#paymentForm').submit(function(e) {
            e.preventDefault();
            showProcessing(true);

            const set_default = $('#is_default_payment').is(':checked');

            if (paymentMethodType === 'card') {
                // Create a payment method with card
                stripe.createPaymentMethod({
                    type: 'card',
                    card: card,
                    billing_details: {
                        name: '{{ user.get_full_name|default:user.email }}',
                        email: '{{ user.email }}'
                    }
                }).then(handlePaymentMethodResult);
            } else if (paymentMethodType === 'sepa_debit') {
                const accountHolderName = $('#account_holder_name').val();

                if (!accountHolderName) {
                    document.getElementById('paymentErrors').textContent = 'Please enter the account holder name.';
                    showProcessing(false);
                    return;
                }

                // Create a payment method with SEPA Direct Debit
                stripe.createPaymentMethod({
                    type: 'sepa_debit',
                    sepa_debit: iban,
                    billing_details: {
                        name: accountHolderName,
                        email: '{{ user.email }}'
                    }
                }).then(handlePaymentMethodResult);
            }

            function handlePaymentMethodResult(result) {
                if (result.error) {
                    // Show error in the form
                    const errorElement = document.getElementById('paymentErrors');
                    errorElement.textContent = result.error.message;
                    showProcessing(false);
                } else {
                    // Send payment method ID to your server
                    fetch('{% url "payment_create" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({
                            payment_method_id: result.paymentMethod.id,
                            payment_method_type: paymentMethodType,
                            set_default: set_default
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        showProcessing(false);

                        if (data.success) {
                            $('#paymentModal').addClass('hidden');
                            showNotification(data.message, 'success');
                            // Reload page to show updated payment methods
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        } else {
                            document.getElementById('paymentErrors').textContent = data.message;
                            showNotification(data.message, 'error');
                        }
                    })
                    .catch(error => {
                        showProcessing(false);
                        console.error('Error:', error);
                        showNotification('An error occurred while saving the payment method', 'error');
                    });
                }
            }
        });

        // Set as default payment method
        $('.makeDefaultPaymentBtn').click(function() {
            const paymentId = $(this).data('payment-id');
            showProcessing(true);

            fetch(`/account/payments/${paymentId}/default/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                showProcessing(false);

                if (data.success) {
                    showNotification(data.message, 'success');
                    // Reload page to show updated default payment method
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showNotification(data.message, 'error');
                }
            })
            .catch(error => {
                showProcessing(false);
                console.error('Error:', error);
                showNotification('An error occurred while setting default payment method', 'error');
            });
        });

        // Open delete confirmation modal
        $('.deletePaymentBtn').click(function() {
            const paymentId = $(this).data('payment-id');
            $('#confirmDeletePaymentBtn').data('payment-id', paymentId);
            $('#deletePaymentModal').removeClass('hidden');
        });

        // Close delete confirmation modal
        $('#cancelDeletePaymentBtn').click(function() {
            $('#deletePaymentModal').addClass('hidden');
        });

        // Confirm delete payment method
        $('#confirmDeletePaymentBtn').click(function() {
            const paymentId = $(this).data('payment-id');
            showProcessing(true);

            fetch(`/account/payments/${paymentId}/delete/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                showProcessing(false);
                $('#deletePaymentModal').addClass('hidden');

                if (data.success) {
                    showNotification(data.message, 'success');
                    // Reload page to show updated payment methods
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showNotification(data.message, 'error');
                }
            })
            .catch(error => {
                showProcessing(false);
                $('#deletePaymentModal').addClass('hidden');
                console.error('Error:', error);
                showNotification('An error occurred while deleting the payment method', 'error');
            });
        });

        // Initialize with card element on first load
        setupCardElement();
    });
</script>
{% endblock %}
{% endblock %}